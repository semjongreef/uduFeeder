<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>When can eat</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap"
      rel="stylesheet"
    />
  </head>

  <body
    class="flex justify-center items-center h-screen bg-black text-white font-sans"
  >
    <div class="text-center p-8 rounded-lg">
      <!-- Referencing image from public/assets/ folder -->
      <img
        src="/public/assets/udu.png"
        alt="Cat Picture"
        class="w-72 h-auto shadow-md rounded-lg"
      />

      <div class="text-2xl mt-6 font-semibold">
        <h2>Udu üê± ate last at:</h2>
      </div>
      <!-- Time display -->
      <div id="eatingTime" class="text-xl mt-6 font-semibold">
        Loading time...
      </div>
      <div id="timeWithoutFood" class="text-xl mt-6 font-semibold">
        Loading time without food...
      </div>

      <!-- how long without food with timer -->
      <!-- current  -->
      <br />
      <button
        class="mt-6 px-8 py-3 text-white-500 bg-red-500 font-semibold rounded-lg shadow-md hover:bg-red-400 focus:outline-none focus:ring-2 focus:ring-red-4200"
        onclick="setEatingTime()"
      >
        FEED ME üçó
      </button>
    </div>
    <script>
      const API_URL = "http://localhost:3000/feed";
      let eatingTime = null;
      // Function to format the time
      function getTimeInCorrectFormat(utcTimestamp) {
        const tallinnTime = new Intl.DateTimeFormat("en-GB", {
          timeZone: "Europe/Tallinn",
          year: "numeric",
          month: "2-digit",
          day: "2-digit",
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
        }).formatToParts(new Date(utcTimestamp));

        const formattedTime = `${
          tallinnTime.find((p) => p.type === "hour").value
        }:${tallinnTime.find((p) => p.type === "minute").value}:${
          tallinnTime.find((p) => p.type === "second").value
        } ${tallinnTime.find((p) => p.type === "day").value}.${
          tallinnTime.find((p) => p.type === "month").value
        }.${tallinnTime.find((p) => p.type === "year").value}`;

        return formattedTime;
      }

      function fetchEatingTime() {
        fetch(API_URL)
          .then((response) => {
            if (!response.ok) {
              throw new Error("Network response was not ok");
            }
            return response.json(); // Parse JSON response
          })
          .then((data) => {
            // Update the DOM with the fetched data
            const messageDiv = document.getElementById("eatingTime");
            // set global eating time var
            eatingTime = data.time;
            const time = getTimeInCorrectFormat(data.time);
            messageDiv.textContent = time;
          })
          .catch((error) => {
            // Handle errors
            console.error("Fetch error:", error);
            const messageDiv = document.getElementById("eatingTime");
            messageDiv.textContent = "Failed to load data.";
          });
      }

      fetchEatingTime();

      function setEatingTime() {
        fetch(API_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error("Network response was not ok");
            }
            return response.json();
          })
          .then((data) => {
            console.log("data post", data);
            fetchEatingTime();
          })
          .catch((error) => {
            // Handle errors
            console.error("Fetch error:", error);
            const messageDiv = document.getElementById("time");
            messageDiv.textContent = "Failed to load data.";
          });
      }

      function calculateTimeWithoutFood() {
        const now = new Date();
        const timeLastAte = new Date(eatingTime);
        const timeWithoutFood = now - timeLastAte;

        // Calculate the difference in hours, minutes, and seconds
        const hours = Math.floor(timeWithoutFood / (1000 * 60 * 60));
        const minutes = Math.floor((timeWithoutFood % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((timeWithoutFood % (1000 * 60)) / 1000);

        // Format the result as "X hours Y minutes Z seconds"
        const timeRange = `${hours} hours ${minutes} minutes ${seconds} seconds`;
        const timeWithoutFoodElem = document.getElementById("timeWithoutFood");
        timeWithoutFoodElem.textContent = timeRange;
      }

      setInterval(() => {
        calculateTimeWithoutFood();
      }, 1000)

    </script>
  </body>
</html>
